# Fay Prompt 设计文档

> **提示**：使用 AI IDE 对 Fay 进行 Prompt 改造时，可以让 AI 参考 `docs/Prompt设计文档.md`

本文档详细说明 Fay 数字人系统中使用的各类 Prompt 设计及其工作流程。

## 1. Prompt 类型与功能对比

Fay 系统采用 **双阶段 Prompt 架构**，通过规划器和最终输出两个阶段协同工作：

| Prompt 类型        | 功能定位               | 输出格式    | 执行方式 | 使用场景         |
| ----------------- | -------------------- | --------- | ------ | -------------- |
| **系统 Prompt**    | 定义 AI 人设和行为规范      | 自然语言    | -    | 贯穿整个对话流程     |
| **规划器 Prompt**   | 决策下一步行动（调用工具或直接回复） | 严格 JSON | 同步   | 需要工具调用或复杂决策时 |
| **最终输出 Prompt**  | 生成自然语言回复           | 口语化文本   | 同步   | 生成最终用户可见的回复  |
| **记忆重要性 Prompt** | 评估对话内容的记忆价值        | 0-10 数值 | 异步   | 记忆存储时评估重要性   |
| **用户画像 Prompt**  | 从对话中提取用户特征         | 结构化文本   | 异步   | 更新用户画像信息     |
| **记忆反思 Prompt**  | 对历史记忆进行归纳总结        | 高层次洞察   | 异步   | 定期反思生成抽象记忆   |

### 1.1 规划器Prompt及最终输出Prompt功能对比详解

| 特性                 | 规划器 Prompt                 | 最终输出 Prompt         |
| -------------------- | ---------------------------- | --------------------- |
| **System Message** | `你负责规划下一步行动，请严格输出合法 JSON。` | 直接输出|
| **包含可用工具列表**       | 是                          | 否                   |
| **输出要求**           | JSON 格式                    | 自然口语                |
| **支持流式输出**         | 是（finish+message 模式）       | 是                   |
| **预启动工具结果**        | 包含                         | 包含                  |
| **关联记忆**           | 包含                         | 包含                  |
| **最近对话**           | 包含                         | 包含                  |

### 1.2 执行效率对比

| 场景         | 执行路径                            | LLM 调用次数 | 适用情况       |
| ------------ | --------------------------------- | ---------- | ------------ |
| **简单问答**   | 规划器 → finish+message            | 1 次      | 无需工具，直接回复  |
| **单次工具调用** | 规划器 → 工具 → 规划器 → finish+message | 2 次      | 需要一次工具辅助   |
| **N次工具调用** | 规划器 → (工具 → 规划器) × N → finish   | N+1 次    | 复杂任务需多次工具  |
| **预启动优化**  | 预启动 → 规划器 → finish+message      | 1 次      | 预启动已获取所需信息 |

> **说明**：每次工具执行后都需要回到规划器决策下一步行动，因此 N 次工具调用需要 N+1 次 LLM 调用。当规划器返回 `finish+message` 时，直接使用 message 内容，无需额外调用最终输出 LLM。

#### 效率优化机制

1. **finish+message 快速路径**
   
   - 规划器直接在 JSON 中返回 `{"action": "finish", "message": "..."}`
   - 跳过最终输出阶段，节省一次 LLM 调用
   - 无论是否使用工具，只要规划器返回 message 就直接使用

2. **预启动工具预取**
   
   - 常用信息（时间、天气等）在用户提问前自动获取
   - 规划器可直接使用预取结果，减少工具调用次数
   - 适合高频查询场景

3. **流式输出**
   
   - 规划器的 message 支持流式输出
   - 用户无需等待完整生成即可看到内容
   - 提升感知响应速度

#### 典型场景 LLM 调用次数

| 场景            | 调用次数 | 说明                                 |
| --------------- | -------- | ------------------------------------ |
| "你好"          | 1 次  | 规划器直接 finish+message               |
| "现在几点" (有预启动) | 1 次  | 预启动已获取时间，规划器直接回复                   |
| "帮我查天气"       | 2 次  | 规划器(1) → 工具 → 规划器(2) → finish      |
| "设置闹钟"        | 2 次  | 规划器(1) → 工具 → 规划器(2) → finish      |
| "查天气并设置提醒"    | 3 次  | 规划器(1) → 工具 → 规划器(2) → 工具 → 规划器(3) |

---

## 2. Prompt 示例

### 2.1 系统 Prompt 示例

系统 Prompt 由用户在配置文件中定义（GUI可以管理），用于设定 AI 的人设：

```
**系统设定**
你是一个名叫Fay的数字人助手。你性格温柔、善解人意，说话简洁明了。
你会用亲切的语气与用户交流，称呼用户为"主人"。
---
```

### 2.2 规划器 Prompt 示例

~~~
**提问内容**
主人：
```
今天天气怎么样？
```
---
**系统设定**
你是一个名叫Fay的数字人助手...
---

**额外观察**
（无补充）
---

**关联记忆**
（无相关记忆）
---

**预启动工具结果**
【query_weather】(city=北京)
```
北京今日晴，气温 -2°C 至 8°C，空气质量良好
```
---

**可用工具**
- query_weather: 查询天气信息
  参数: city (string) - 城市名称
- add_schedule: 添加日程
  参数: title (string), content (string), schedule_time (string)
---

**历史工具执行**
（无）
---

**最近对话**
主人：
```
你好
```
Fay：
```
主人，你好呀！有什么我可以帮你的吗？
```
---

请返回 JSON，格式如下：
- 若需要调用工具：
    {"action": "tool", "tool": "工具名", "args": {...}}
- 若直接回复（需附带回复内容）：
    {"action": "finish", "message": "你的回复内容"}
~~~

**规划器输出示例：**

```json
{"action": "finish", "message": "主人，北京今天是晴天，气温在零下2度到8度之间，空气质量良好，适合出门活动哦！"}
```

### 2.3 最终输出 Prompt 示例

~~~
**提问内容**
主人：
```
帮我设置一个明天早上9点的闹钟
```
---
**系统设定**
你是一个名叫Fay的数字人助手...
---

**关联记忆**
（无相关记忆）
---

**其他观察**
（无补充）
---

**工具执行摘要**
add_schedule(title=早起闹钟, schedule_time=09:00) → 日程添加成功，ID: 15
---

**最近对话**
主人：
```
帮我设置一个明天早上9点的闹钟
```
---
~~~

**最终输出示例：**

```
好的主人，我已经帮你设置好明天早上9点的闹钟了，到时候会提醒你的！
```

---

## 3. 工作流程

### 3.1 整体架构

```
用户输入
    ↓
┌─────────────────────────────────────────────────────────┐
│                    预处理阶段                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ 加载系统    │  │ 检索关联   │  │ 执行预启动  │     │
│  │ Prompt     │  │ 记忆       │  │ 工具        │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────────┐
│                  规划器阶段 (Planner)                    │
│                                                         │
│  输入: 规划器 Prompt (含工具列表、对话历史、记忆等)       │
│  输出: JSON 决策                                        │
│        ├─ {"action": "tool", ...}  → 执行工具 → 循环    │
│        └─ {"action": "finish", "message": "..."}        │
│                         ↓                               │
│              (可选) 流式输出 message                     │
└─────────────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────────┐
│                最终输出阶段 (Final Output)               │
│                                                         │
│  输入: 最终输出 Prompt (含工具执行摘要、规划器建议等)     │
│  输出: 自然语言回复 (流式)                               │
└─────────────────────────────────────────────────────────┘
    ↓
用户看到回复
    ↓
┌─────────────────────────────────────────────────────────┐
│              异步后处理阶段 (Background)                 │
│                                                         │
│  ┌─────────────────┐  ┌─────────────────┐              │
│  │ 记忆重要性评估   │  │ 用户画像更新    │              │
│  │ (记忆重要性      │  │ (用户画像       │              │
│  │  Prompt)        │  │  Prompt)        │              │
│  └─────────────────┘  └─────────────────┘              │
│           ↓                    ↓                        │
│  ┌─────────────────────────────────────────┐           │
│  │           记忆存储与索引                 │           │
│  └─────────────────────────────────────────┘           │
│                        ↓                                │
│  ┌─────────────────────────────────────────┐           │
│  │    定期反思 (记忆反思 Prompt)            │           │
│  │    归纳总结历史记忆，生成高层次洞察       │           │
│  └─────────────────────────────────────────┘           │
└─────────────────────────────────────────────────────────┘
```

### 3.2 详细流程说明

#### 阶段一：预处理

1. **加载系统 Prompt**：从配置获取 AI 人设定义
2. **检索关联记忆**：基于用户输入从记忆库中检索相关内容
3. **执行预启动工具**：自动执行配置的预启动 MCP 工具，获取上下文信息

#### 阶段二：规划器决策

```python
# 规划器循环
while True:
    # 构建规划器 Prompt
    messages = _build_planner_messages(state)

    # 调用 LLM 获取决策
    result = call_llm(messages)  # 返回 JSON

    if result["action"] == "tool":
        # 执行工具
        tool_result = execute_tool(result["tool"], result["args"])
        # 将结果加入历史，继续循环
        state["tool_results"].append(tool_result)

    elif result["action"] == "finish":
        # 如果有 message，可直接流式输出
        if result.get("message"):
            stream_output(result["message"])
        break
```

#### 阶段三：最终输出

```python
# 构建最终输出 Prompt
messages = _build_final_messages(state)

# 流式生成自然语言回复
for chunk in stream_llm(messages):
    yield chunk
```

#### 阶段四：异步后处理（后台执行）

对话完成后，系统在后台异步执行以下任务，不影响用户体验：

```python
# 1. 记忆重要性评估
importance = evaluate_importance(conversation)  # 返回 0-10

# 2. 用户画像更新
profile_updates = extract_user_profile(conversation)
update_user_profile(user_id, profile_updates)

# 3. 记忆存储
if importance >= threshold:
    store_memory(conversation, importance)

# 4. 定期反思（由调度器触发）
if should_reflect():
    insights = reflect_on_memories(recent_memories)
    store_reflection(insights)
```

**异步 Prompt 说明：**

| Prompt 类型        | 触发时机    | 输入          | 输出         |
| ------------------ | ---------- | ------------- | ------------ |
| **记忆重要性 Prompt** | 每轮对话结束后 | 对话内容        | 0-10 重要性分数 |
| **用户画像 Prompt**  | 每轮对话结束后 | 对话内容 + 现有画像 | 画像更新字段     |
| **记忆反思 Prompt**  | 定期触发    | 近期记忆列表      | 高层次洞察总结    |

### 3.3 Prompt 各部分说明

| 部分          | 说明             | 来源        |
| ------------- | ---------------- | ----------- |
| **提问内容**    | 当前用户输入         | 用户消息      |
| **系统设定**    | AI 人设定义        | 配置文件（GUI可管理）      |
| **关联记忆**    | 与问题相关的历史记忆     | 记忆检索模块    |
| **预启动工具结果** | 自动执行的工具返回      | MCP 预启动工具 |
| **可用工具**    | 当前可调用的工具列表     | MCP 工具注册  |
| **历史工具执行**  | 本轮对话中已执行的工具及结果 | 规划器循环累积   |
| **最近对话**    | 近期对话历史         | 对话缓存      |

### 3.4 特殊标签处理

系统使用特殊 XML 标签来标记和管理某些内容：

#### `<prestart>` 标签

| 属性 | 说明 | 在 Prompt 中的表现 |
| ---- | ---- | ------------------ |
| 无属性 | 临时预启动结果 | 仅在当前轮对话的 Prompt 中出现，下一轮自动移除 |
| `keep="true"` | 持久预启动结果 | 保留在对话历史中，后续轮次的 **最近对话** 模块中持续可见 |

**使用场景**：
- 预启动工具配置 `include_history: false`（默认）时，结果用 `<prestart>` 包裹
- 预启动工具配置 `include_history: true` 时，结果用 `<prestart keep="true">` 包裹

#### `<think>` 标签

| 场景 | 说明 | 在 Prompt 中的表现 |
| ---- | ---- | ------------------ |
| 工具调用过程 | 包裹规划器的工具调用决策过程 | 从对话历史中移除，不进入后续 Prompt |
| 模型思考内容 | 兼容带思考标签的模型（如 DeepSeek R1） | 解析 JSON 前自动移除 |

**处理逻辑**：
- `<think>` 标签内容在构建 **最近对话** 时会被移除
- 用户看到的流式输出中可能包含 `<think>` 标签（显示思考过程）
- 但这些内容不会进入后续对话的 Prompt

### 3.5 预启动工具结果格式

预启动工具的结果采用特定格式展示：

~~~
**预启动工具结果**
【工具名】(参数...)
```
工具返回的结果内容
```
---
~~~

如果工具配置了 `include_history: true`，其结果会以 `<prestart keep="true">` 标签保存在对话历史中，在后续对话中持续可见。

### 3.6 流式输出机制

规划器支持 `finish + message` 模式的流式输出：

1. 当规划器返回 `{"action": "finish", "message": "..."}` 时
2. 系统会流式输出 `message` 内容
3. 同时跳过最终输出阶段（避免重复生成）

这样可以实现更快的响应速度，用户无需等待两次 LLM 调用。

---

## 4. 最佳实践

### 4.1 系统 Prompt 编写建议

- 明确定义 AI 的名称、性格特点
- 设定说话风格和语气
- 指定对用户的称呼方式
- 避免过长，控制在 200 字以内

### 4.2 工具设计建议

- 工具描述要清晰，让 LLM 能准确判断何时使用
- 参数说明要完整，包含类型和示例
- 返回结果要简洁，便于 LLM 理解和转述

### 4.3 预启动工具使用建议

- 用于获取实时上下文（如时间、天气、用户状态）
- 配置 `include_history: true`（保存到记忆） 可让结果在多轮对话中持续可见
- 避免预启动工具执行时间过长，影响响应速度
